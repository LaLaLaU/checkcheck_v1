# CheckCheck 导管喷码自动核对系统 - 详细实施计划

**版本**: 1.4
**基于PRD版本**: 1.0
**日期**: 2025-04-28
**更新说明**: V1.4 - 更新相机功能实现状态，确认相机相关功能已完成，而非推迟。

## 概述

本计划基于《CheckCheck 导管喷码自动核对系统 - 产品需求文档 (PRD)》 V1.0 制定，旨在提供一个更具体、可操作的项目实施路线图。总计划周期预计为6-7周（考虑了测试确认环节）。

## 阶段一：基础框架搭建与环境准备 (预计 1 周)

**目标**: 搭建项目开发环境，**实现基础的图片加载与显示功能**，完成初步的UI原型设计（包含图片上传）。

**主要任务**：

1.  **环境搭建**：
    *   [✓] 安装 Python 3.8+
    *   [✓] 安装必要的库: PyQt5, OpenCV-Python, PaddleOCR, NumPy, Difflib
    *   [✓] 配置虚拟环境 (使用conda)
    *   [✓] 初始化 Git 版本控制仓库
2.  **相机视频流获取**：
    *   [✓] 编写代码以检测并连接到工业相机
    *   [✓] 使用 OpenCV (`cv2.VideoCapture`) 捕获实时视频流
    *   [✓] 实现基本的错误处理 (如相机未找到)
3.  **基础UI原型设计与图片加载**：
    *   [✓] 使用 PyQt5 创建主窗口框架
    *   [✓] 设计主界面布局草图 (包含**图片显示区 (替代视频预览区)**, 结果显示区, 控制区)
    *   [✓] **实现"上传图片"按钮功能，允许用户选择本地图片文件**
    *   [✓] **实现将用户上传的图片显示在 PyQt5 界面的图片显示区** (例如，使用 `QLabel`)
    *   [✓] 添加基本的控制按钮框架 (例如 "开始识别", "设置", "历史记录")
4.  **阶段测试与确认**：
    *   [✓] **内部测试**: 验证环境配置正确，图片能够成功加载并显示在UI上。
    *   [✓] **用户确认**: 向您演示基础UI框架和图片加载显示功能，确认满足初步预期。

**产出物**：
*   [✓] 配置好的开发环境
*   [✓] 可运行的基础应用程序，**能加载并显示用户上传的图片**
*   [✓] 初步的主界面UI框架代码 (包含图片上传功能)
*   [✓] Git 仓库建立
*   [✓] 阶段一用户确认记录

## 阶段二：核心功能开发 (基于上传图片) (预计 2-3 周)

**目标**: **基于用户上传的图片**，实现图像中的自动区域检测、OCR文字识别以及文本比对核心算法。每个核心功能完成后需进行测试和用户确认。

**主要任务**: (任务内容不变，但输入源变为上传的图片)

1.  **自动区域检测**：
    *   [✓] **实现区域检测逻辑**: 已切换为使用 PaddleOCR 的检测模型，替代 MSER。
    *   [✓] **测试与调整**: 完成了初步测试，PaddleOCR 检测效果良好，并根据反馈调整了 UI 字体大小。
    *   [✓] **用户确认 1**: 基于上传图片的区域检测效果已确认。
2.  **OCR引擎集成与优化**：
    *   [✓] **实现 OCR 识别**: 利用现有的 OcrEngine 对检测到的区域进行文字识别。
    *   [✓] **测试与确认**: 基于上传图片的OCR识别结果已通过测试确认。
    *   [✓] **用户确认 2**: 基于上传图片的OCR识别结果已确认。
3.  **文本比对算法**：
    *   [✓] **实现比对逻辑**: 利用现有的 TextComparator 对识别出的文本进行比对。
    *   [✓] **测试与确认**: 文本比对逻辑和结果已通过测试确认。
    *   [✓] **用户确认 3**: 文本比对逻辑和结果已确认。

**产出物**：
*   [✓] 可独立运行的核心处理模块 (RegionDetector, OcrEngine, TextComparator)
*   ...

## 阶段三：用户界面与交互完善 (预计 1-2 周)

**目标**: 完成主界面、设置界面和历史记录界面的开发，集成核心功能，优化用户交互。

**主要任务**：

1.  **主界面完善**：
    *   [✓] 将核心功能模块集成到主界面流程中 (**触发方式为点击按钮处理当前显示的图片**)
    *   [✓] **结果显示优化**: 使用 HTML 格式化高亮文本差异
    *   [✓] **结果区布局优化**: 使用 QFormLayout, 调整间距, 移除冗余标签
    *   [✓] **视觉反馈增强**: 按钮添加图标和 QSS 样式，处理状态时禁用按钮并更新文本
    *   [✓] **结果清晰度提升**: 调整匹配逻辑 (100%通过), 添加 ✔/✘ 图标，解决对齐问题
2.  **设置界面开发**：
    *   [ ] 创建设置对话框或窗口
    *   [✓] **实现相机参数 (分辨率、曝光等) 的读取与设置**
    *   [ ] **实现OCR参数 (如置信度阈值) 的配置 (推迟，根据后续识别效果决定)**
    *   [ ] 实现系统行为设置 (如结果自动保存开关)
    *   [ ] 实现设置的保存与加载
3.  **历史记录功能**：
    *   [✓] **数据库集成**: 创建 `history` 表，保存处理结果 (时间戳, 图片路径, 标牌文本, 喷码文本, 相似度, 结果)
    *   [✓] **历史记录窗口**: 创建 `HistoryWindow`，使用 `QTableWidget` 显示历史数据
    *   [✓] **数据加载**: 从数据库读取数据并填充表格
    *   [✓] **图片预览**: 实现点击表格中的图片路径弹出预览窗口
    *   [✓] **UI 优化**: 将图片路径样式改为蓝色带下划线，暗示可点击
    *   [✓] **差异显示增强**: 在表格中使用 `QTextEdit` 渲染HTML，以**彩色粗体**显示文本差异
    *   [✓] **文本搜索**: 添加搜索框，支持在标牌/喷码文字中搜索关键词
    *   [✓] **结果筛选**: 添加下拉框，支持按"通过"/"不通过"筛选结果
    *   [✓] **搜索高亮**: 搜索到的关键词在单元格内以黄色背景高亮显示
4.  **相机集成**：
    *   [✓] **相机初始化与线程管理**: 创建 `CameraWorker` 类，实现摄像头线程和资源管理
    *   [✓] **实时预览**: 将摄像头捕获的帧显示在界面上
    *   [✓] **相机错误处理**: 实现相机连接/断开/错误的处理和界面反馈
    *   [✓] **识别按钮集成**: 支持对当前摄像头帧执行文本识别
5.  **阶段测试与确认**：
    *   [ ] **内部测试**: 验证界面功能完整性、易用性，**包括相机相关**参数配置生效，历史记录准确。
    *   [ ] **用户确认**: 向您演示完整的界面交互流程（**包括图片处理和相机处理**）、设置功能和历史记录功能，确认满足要求。

**产出物**：
*   功能完整并经确认的主界面 (**包括图片处理和相机功能**)
*   可配置参数并经确认的设置界面
*   ... (其他不变) ...

## 阶段四：系统集成测试与优化 (预计 1 周)

**目标**: 对整个系统（**包括相机功能**）进行全面的功能、性能、稳定性测试...

**主要任务**: (测试重点放在图片处理流程上，但同时包括相机功能)
*   ...

## 阶段五：打包、文档与交付 (预计 1 周)

**目标**: 将应用程序打包...

**主要任务**:
*   ...

## 已完成功能

- [x] 基础UI框架
- [x] 相机集成
- [x] 图像上传
- [x] OCR文本识别
- [x] 文本比对
- [x] 历史记录数据库
- [x] 历史记录窗口
- [x] UI优化与美化
- [x] 图片识别闪退问题修复
- [x] 历史记录保存功能
- [x] 识别内容显示可读性提升（在图像上绘制文本框）
- [x] 相机模式下暂停/恢复功能（识别后暂停显示标记画面，可恢复实时预览）
- [x] 图片识别和相机识别模式切换功能（用单一按钮实现模式切换和恢复相机）
- [x] UI改进
    - [x] 简化文本标签为"字符串1"和"字符串2"
    - [x] 固定文本框字体大小为20像素
    - [x] 清空识别结果框
- [x] UI进一步优化
    - [x] 在切换模式和上传新图片时清空识别结果
    - [x] 文本框字体大小根据图片尺寸自动调整
    - [x] 确保文本框不会超出图片边界
    - [x] 文本框背景从半透明改为纯白色，提高可读性
    - [x] 将置信度字体大小调整为主文本的一半，并使用灰色显示，便于区分

## 当前进行中

- [ ] 文本区分策略优化（不依赖Y坐标）

## 待实施功能

- [ ] 设置功能
- [ ] 批量处理
- [ ] 报表生成
- [ ] 用户手册